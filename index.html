
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« å¹»ç‡ˆç‰‡</title>

    <!-- Google Fonts: Noto Serif TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base and Font Setup --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            /* Correctly set Noto Serif TC as the primary font */
            font-family: 'Noto Serif TC', serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
            overflow-x: hidden; /* Prevent horizontal scroll on body */
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* --- Header and Typography --- */
        header {
            text-align: center;
            padding: 40px 0 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            color: #2c5282;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(to right, #2c5282, #4a5568);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #4a5568;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c5282;
        }
        
        /* --- App Layout --- */
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 40px;
        }
        
        .input-section, .slides-section {
            padding: 30px;
        }

        .input-section {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .input-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .input-header i {
            font-size: 28px;
            color: #3182ce;
        }
        
        /* --- Form Elements and Controls --- */
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s;
            background: white;
            /* Ensure textarea uses the correct font */
            font-family: 'Noto Serif TC', serif;
        }
        
        textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.2);
        }
        
        .char-count {
            text-align: right;
            color: #718096;
            font-size: 14px;
            font-weight: 500;
            /* Use a sans-serif font for UI clarity */
            font-family: 'Segoe UI', sans-serif;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            font-size: 17px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            /* Use a clear, readable sans-serif font for buttons */
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #3182ce, #2b6cb0);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #2b6cb0, #2c5282);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(43, 108, 176, 0.35);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #e53e3e, #c53030);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(to right, #c53030, #9b2c2c);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(197, 48, 48, 0.35);
        }
        
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- Slides and Carousel --- */
        .slides-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .slides-container {
            display: flex;
            overflow-x: auto;
            gap: 30px;
            padding: 20px; /* Increased padding to show overflow */
            margin: 0 -20px; /* Negative margin to compensate padding */
            scroll-behavior: smooth;
            min-height: 550px;
            align-items: center;
            scrollbar-width: thin;
            scrollbar-color: #3182ce #e2e8f0;
        }
        
        .slides-container::-webkit-scrollbar { height: 10px; }
        .slides-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .slides-container::-webkit-scrollbar-thumb { background: #3182ce; border-radius: 10px; }
        
        .slide {
            flex: 0 0 400px; /* Do not shrink, do not grow, base width 400px */
            width: 400px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #e2e8f0;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.18);
        }
        
        .slide-header {
            background: #2c5282;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600;
        }
        
        .slide-image {
            width: 100%;
            height: 400px;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #e2e8f0;
            position: relative; /* Needed for positioning regeneration UI */
            text-align: center; /* Center content like error messages */
            padding: 20px;
        }
        
        .slide-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
            padding: 0; /* Reset padding for the image itself */
        }
        
        /* ã€æ–°å¢ã€‘åœ–ç‰‡ç”Ÿæˆå¤±æ•—æ™‚çš„é‡è©¦æ¨£å¼ */
        .generation-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            cursor: pointer;
            color: #c53030;
            border: 2px dashed #e53e3e;
            border-radius: 12px;
            height: 100%;
            width: 100%;
            transition: background-color 0.3s;
        }
        .generation-error:hover {
            background-color: #fed7d7;
        }
        .generation-error i {
            font-size: 3rem;
        }
        .generation-error p {
            font-weight: 600;
            font-size: 1rem;
            line-height: 1.5;
        }

        .slide-text {
            padding: 20px;
            font-size: 16px;
            line-height: 1.7;
            color: #2d3748;
            min-height: 150px;
            background: #f8fafc;
        }

        .placeholder, .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #718096;
            padding: 30px;
            flex-grow: 1; /* Make it fill the container */
        }
        
        .placeholder i { font-size: 70px; margin-bottom: 25px; color: #cbd5e0; opacity: 0.7; }
        .placeholder p { font-size: 18px; max-width: 500px; line-height: 1.6; font-weight: 500; }
        .loading { gap: 25px; padding: 50px; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(49, 130, 206, 0.15);
            border-top: 6px solid #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .slide-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .slide-nav {
            background: #3182ce;
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(49, 130, 206, 0.3);
        }
        
        .slide-nav:hover {
            background: #2b6cb0;
            transform: scale(1.08);
            box-shadow: 0 6px 15px rgba(49, 130, 206, 0.4);
        }
        
        .slide-nav:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* --- Utilities --- */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 28px;
            border-radius: 10px;
            background: #38a169;
            color: white;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.4s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.error { background: #e53e3e; }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #3182ce, #2b6cb0);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            color: #4a5568;
            font-size: 15px;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        
        /* --- Responsive Design --- */
        
        /* For Tablets (and large mobile) */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .app-container {
                gap: 20px;
            }
            h1 {
                font-size: 2.2rem;
            }
            .subtitle {
                font-size: 1.1rem;
            }
            .input-section, .slides-section {
                padding: 25px;
            }
            .slide {
                flex-basis: 340px;
                width: 340px;
            }
            .slide-image {
                height: 340px;
            }
            .slides-container {
                min-height: 520px;
            }
        }
        
        /* For Mobile phones */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .subtitle {
                font-size: 1rem;
            }
            .input-section, .slides-section {
                padding: 20px;
            }
            .controls {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* Responsive slide sizing */
            .slide {
                flex-basis: 85vw; /* Set base width relative to viewport */
                width: 85vw;
                max-width: 320px; /* Prevent it from getting too large */
            }
            
            .slide-image {
                height: 85vw;
                max-height: 320px;
            }

            .slide-header {
                font-size: 16px;
                padding: 12px 15px;
            }

            .slides-container {
                min-height: 480px;
                padding: 20px 15px;
                margin: 0 -15px;
            }
        }


/* --- é€šç”¨è¼¸å…¥æ¡†æ‡¸æµ®è¦–çª— (CSS) --- */

/* 1. è®“æ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„è¼¸å…¥æ¡†çœ‹èµ·ä¾†å¯ä»¥é»æ“Š */
textarea:not(.no-modal-editor),
input[type="text"]:not(.no-modal-editor) {
cursor: pointer; /* æ»‘é¼ è®Šæˆæ‰‹å½¢æŒ‡æ¨™ */
background-color: #f0f8ff; /* æ·¡è—è‰²èƒŒæ™¯æç¤º */
transition: background-color 0.2s;
}

/* 2. ç•¶æ»‘é¼ æ‡¸åœæ™‚ï¼ŒèƒŒæ™¯è‰²ç¨æ·±ä¸€é» */
textarea:not(.no-modal-editor):hover,
input[type="text"]:not(.no-modal-editor):hover {
background-color: #e6f2ff;
}

/* 3. æ‡¸æµ®è¦–çª—æœ¬èº«çš„æ¨£å¼ (èˆ‡ä¹‹å‰ç›¸åŒï¼Œå¯ç›´æ¥è¦†è“‹) */
.outline-modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.65);
z-index: 2000;
justify-content: center;
align-items: center;
padding: 1rem;
box-sizing: border-box;
}

.outline-modal-content {
    background-color: #fdfdfd;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    
    /* --- ä»¥ä¸‹æ˜¯æ ¸å¿ƒä¿®æ”¹ --- */
    width: 90vw;  /* è¨­å®šå¯¬åº¦ç‚ºè¦–çª—å¯¬åº¦çš„ 90% */
    height: 90vh; /* è¨­å®šé«˜åº¦ç‚ºè¦–çª—é«˜åº¦çš„ 90% */
    /* max-width å·²è¢«ç§»é™¤ï¼Œä»¥å…è¨±è¦–çª—åœ¨å¤§è¢å¹•ä¸Šå®Œå…¨å±•é–‹ */

    position: relative;
    animation: fadeIn 0.3s;
    display: flex;
    flex-direction: column;
}

.outline-modal-content h3 {
margin-top: 0;
margin-bottom: 15px;
color: #333;
font-size: 1.2em;
font-weight: 700;
}

#modal-textarea {
width: 100%;
box-sizing: border-box;
font-size: 1.3em;
line-height: 1.6;
border: 1px solid #ccc;
border-radius: 8px;
padding: 10px;
flex-grow: 1;
min-height: 250px;
}

.outline-modal-content .modal-buttons {
text-align: right;
margin-top: 15px;
}

.outline-modal-content .preview-close-btn {
position: absolute;
top: 10px;
right: 10px;
}

/* ç¢ºä¿æŒ‰éˆ•æ¨£å¼ä¹Ÿè¢«è¤‡è£½ */
.btn-action {
display: inline-block;
padding: 10px 20px;
margin: 5px;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: bold;
font-family: 'Noto Serif TC', serif;
transition: all 0.3s ease;
border: 2px solid white;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
color: white;
background-color: rgba(31, 122, 85, 0.8);
backdrop-filter: blur(5px);
text-align: center;
text-decoration: none;
}
.btn-action:hover {
transform: translateY(-2px);
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
filter: brightness(110%);
}
        

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ–‡ç« å¹»ç‡ˆç‰‡</h1>
        </header>
        
        <div class="app-container">
            <div class="input-section">
                <div class="input-header">
                    <i class="fas fa-edit"></i>
                    <h2>è¼¸å…¥æ–‡ç« å…§å®¹</h2>
                </div>
                
                <div class="input-container">
                    <textarea id="article-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç¹é«”ä¸­æ–‡æ–‡ç« å…§å®¹..."></textarea>
                    <div class="char-count">å­—æ•¸: <span id="char-count">0</span></div>
                </div>
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="controls">
                    <button id="generate-btn" class="btn btn-primary">
                        <i class="fas fa-magic"></i> ç”Ÿæˆå¹»ç‡ˆç‰‡
                    </button>
                    <button id="reset-btn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> é‡ç½®å…§å®¹
                    </button>
                </div>
            </div>
            
            <div class="slides-section">
                <div class="slides-header">
                    <div class="input-header">
                        <i class="fas fa-images"></i>
                        <h2>å¹»ç‡ˆç‰‡å±•ç¤º</h2>
                    </div>
                </div>
                
                <div class="slides-container" id="slides-container">
                    <div class="placeholder">
                        <i class="fas fa-scroll"></i>
                        <p>è¼¸å…¥æ–‡ç« ä¸¦é»æ“Šã€Œç”Ÿæˆå¹»ç‡ˆç‰‡ã€æŒ‰éˆ•å¾Œï¼Œé€™è£¡å°‡é¡¯ç¤ºå¸¶æœ‰AIç”Ÿæˆæ’åœ–çš„å¹»ç‡ˆç‰‡</p>
                    </div>
                </div>
                
                <div class="slide-controls">
                    <div class="slide-nav" id="prev-slide" title="ä¸Šä¸€å¼µ">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <div class="slide-nav" id="next-slide" title="ä¸‹ä¸€å¼µ">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Â© 2025 é™³å† å¥</p>
        </footer>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span>é€šçŸ¥è¨Šæ¯</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ç²å–DOMå…ƒç´ 
            const articleInput = document.getElementById('article-input');
            const charCount = document.getElementById('char-count');
            const generateBtn = document.getElementById('generate-btn');
            const resetBtn = document.getElementById('reset-btn');
            const slidesContainer = document.getElementById('slides-container');
            const prevSlideBtn = document.getElementById('prev-slide');
            const nextSlideBtn = document.getElementById('next-slide');
            const notification = document.getElementById('notification');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');

            // =======================================================
// === é€šç”¨æ‡¸æµ®è¦–çª—ç·¨è¼¯å™¨ & OCR æ•´åˆé‚è¼¯ é–‹å§‹ ===
// =======================================================

// --- æ‡¸æµ®è¦–çª—æ ¸å¿ƒé‚è¼¯ ---

const modal = document.getElementById('outline-editor-modal');
const modalTextarea = document.getElementById('modal-textarea');
const modalTitle = document.getElementById('modal-title');
const modalSaveBtn = document.getElementById('modal-save-btn');
const modalCloseBtn = document.getElementById('modal-close-btn');
const ocrBtn = document.getElementById('modal-ocr-btn');

if (!modal || !modalTextarea || !modalSaveBtn || !modalCloseBtn || !ocrBtn) {
    console.error("æ‡¸æµ®è¦–çª—çš„ HTML çµæ§‹ä¸å®Œæ•´æˆ–æœªæ‰¾åˆ°ï¼");
} else {
    let currentEditingElement = null;

    function openModalEditor(element) {
        currentEditingElement = element;
        modalTextarea.value = currentEditingElement.value;

        // ã€ç‰¹åˆ¥ä¿®è¨‚ã€‘ç‚ºã€Œæ–‡ç« å¹»ç‡ˆç‰‡ã€çš„è¼¸å…¥æ¡†è¨­å®šå°ˆå±¬æ¨™é¡Œ
        if (element.id === 'article-input') {
            modalTitle.textContent = 'è¼¸å…¥æ–‡ç« å…§å®¹';
        } else {
            modalTitle.textContent = 'ç·¨è¼¯å…§å®¹'; // é è¨­æ¨™é¡Œ
        }
        
        modal.style.display = 'flex';
        modalTextarea.focus();
    }

    function closeModalEditor() {
        modal.style.display = 'none';
        currentEditingElement = null;
    }

    function saveAndCloseEditor() {
        if (currentEditingElement) {
            currentEditingElement.value = modalTextarea.value;
            // è§¸ç™¼ input äº‹ä»¶ï¼Œè®“å­—æ•¸çµ±è¨ˆç­‰åŠŸèƒ½èƒ½å¤ æ›´æ–°
            currentEditingElement.dispatchEvent(new Event('input'));
        }
        closeModalEditor();
    }

    // å°‡é»æ“Šäº‹ä»¶ç›£è½å™¨ç¶å®šåˆ° document.body
    document.body.addEventListener('click', function(event) {
        const target = event.target;
        
        // æˆ‘å€‘åªé—œå¿ƒ ID ç‚º 'article-input' çš„ textarea
        if (target.id === 'article-input' && target.tagName === 'TEXTAREA') {
            // é˜²æ­¢é è¨­è¡Œç‚ºï¼Œä¸¦æ‰“é–‹æˆ‘å€‘çš„ç·¨è¼¯å™¨
            event.preventDefault();
            openModalEditor(target);
        }
    });

    // ç‚ºæ‡¸æµ®è¦–çª—çš„æŒ‰éˆ•å’Œå¤–éƒ¨å€åŸŸç¶å®šäº‹ä»¶
    modalSaveBtn.addEventListener('click', saveAndCloseEditor);
    modalCloseBtn.addEventListener('click', closeModalEditor);
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            closeModalEditor();
        }
    });

    // --- OCR æ•´åˆé‚è¼¯ ---
    
    let ocrWindow = null;
    const VERCEL_OCR_URL = 'https://gemini-ocr-proxy.vercel.app/'; // æ‚¨çš„ OCR å·¥å…·ç¶²å€

    ocrBtn.addEventListener('click', function() {
        if (ocrWindow && !ocrWindow.closed) {
            ocrWindow.focus();
            return;
        }
        ocrWindow = window.open(VERCEL_OCR_URL, 'OCRWindow', 'width=650,height=850,scrollbars=yes,resizable=yes');
    });

    window.addEventListener('message', function(event) {
        // å®‰å…¨æ€§æª¢æŸ¥ï¼šç¢ºä¿è¨Šæ¯ä¾†æºæ˜¯æ‚¨ä¿¡ä»»çš„ OCR å·¥å…·
        if (event.origin !== new URL(VERCEL_OCR_URL).origin) {
            return;
        }

        if (event.data && event.data.type === 'ocrResult') {
            const ocrText = event.data.text;
            
            // å°‡è¾¨è­˜æ–‡å­—é™„åŠ åˆ°æ‡¸æµ®è¦–çª—çš„è¼¸å…¥æ¡†ä¸­
            modalTextarea.value += (modalTextarea.value.trim() ? '\n' : '') + ocrText;
            
            if (ocrWindow) {
                ocrWindow.close();
            }
            modalTextarea.focus();
        }
    });
}
// =======================================================
// === é€šç”¨æ‡¸æµ®è¦–çª—ç·¨è¼¯å™¨ & OCR æ•´åˆé‚è¼¯ çµæŸ ===
// =======================================================
            
            // å­—æ•¸çµ±è¨ˆ
            articleInput.addEventListener('input', function() {
                const text = articleInput.value;
                charCount.textContent = text.length;
            });
            
            // é¡¯ç¤ºé€šçŸ¥
            function showNotification(message, isError = false) {
                const icon = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
                notification.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
                notification.className = 'notification';
                if (isError) {
                    notification.classList.add('error');
                }
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3500);
            }
            
            // é‡ç½®å…§å®¹
            resetBtn.addEventListener('click', function() {
                articleInput.value = '';
                charCount.textContent = '0';
                slidesContainer.innerHTML = `
                    <div class="placeholder">
                        <i class="fas fa-scroll"></i>
                        <p>è¼¸å…¥æ–‡ç« ä¸¦é»æ“Šã€Œç”Ÿæˆå¹»ç‡ˆç‰‡ã€æŒ‰éˆ•å¾Œï¼Œé€™è£¡å°‡é¡¯ç¤ºå¸¶æœ‰AIç”Ÿæˆæ’åœ–çš„å¹»ç‡ˆç‰‡</p>
                    </div>
                `;
                prevSlideBtn.disabled = true;
                nextSlideBtn.disabled = true;
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                showNotification('å·²é‡ç½®æ‰€æœ‰å…§å®¹ï¼');
            });
            
            // ç”Ÿæˆå¹»ç‡ˆç‰‡
            generateBtn.addEventListener('click', async function() {
                const article = articleInput.value.trim();
                
                if (!article) {
                    showNotification('è«‹è¼¸å…¥æ–‡ç« å…§å®¹ï¼', true);
                    return;
                }
                
                generateBtn.disabled = true;
                resetBtn.disabled = true;
                
                slidesContainer.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨ç”Ÿæˆå¹»ç‡ˆç‰‡ï¼Œè«‹ç¨å€™...é€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“</p>
                    </div>
                `;
                
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                
                const paragraphs = splitArticleIntoParagraphs(article);
                
                try {
                    await generateSlidesSequentially(paragraphs);
                    showNotification('å¹»ç‡ˆç‰‡ç”Ÿæˆå®Œæˆï¼');
                } catch (error) {
                    showNotification('ç”Ÿæˆéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦', true);
                    console.error('ç”ŸæˆéŒ¯èª¤:', error);
                    slidesContainer.innerHTML = `
                    <div class="placeholder">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>æŠ±æ­‰ï¼Œç”Ÿæˆæ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>
                    </div>`;
                } finally {
                    generateBtn.disabled = false;
                    resetBtn.disabled = false;
                }
            });
            
            function splitArticleIntoParagraphs(article) {
    const sentences = article.split(/(?<=[ã€‚ï¼ï¼Ÿï¼›])/g);
    const paragraphs = [];
    let currentParagraph = '';

    sentences.forEach(sentence => {
        if ((currentParagraph + sentence).length <= 100) {
            currentParagraph += sentence;
        } else {
            if (currentParagraph.trim()) {
                paragraphs.push(currentParagraph.trim());
            }
            currentParagraph = sentence;
        }
    });

    if (currentParagraph.trim()) {
        paragraphs.push(currentParagraph.trim());
    }

    // ã€æ–°å¢ã€‘å¾Œè™•ç†æ®µè½ï¼Œä¿®æ­£é–‹é ­çš„æ¨™é»ç¬¦è™Ÿ
    // å®šç¾©ä¸æ‡‰å‡ºç¾åœ¨æ®µè½é–‹é ­çš„æ¨™é»ç¬¦è™Ÿåˆ—è¡¨
    const leadingPunctuationsToMove = ['ã€', 'ã€', 'â€', 'â€™', 'ï¼‰', 'ã€‘', 'ã€•', 'ï¼', 'ï¼Œ', 'ã€', 'ï¼š', 'ï¼›'];

    for (let i = 1; i < paragraphs.length; i++) {
        // å¦‚æœç•¶å‰æ®µè½ä¸ç‚ºç©ºï¼Œä¸”å…¶ç¬¬ä¸€å€‹å­—å…ƒåœ¨æˆ‘å€‘çš„ä¿®æ­£åˆ—è¡¨ä¸­
        if (paragraphs[i] && leadingPunctuationsToMove.includes(paragraphs[i][0])) {
            
            // 1. å°‡é€™å€‹æ¨™é»ç¬¦è™ŸåŠ åˆ°å‰ä¸€å€‹æ®µè½çš„çµå°¾
            paragraphs[i - 1] += paragraphs[i][0];
            
            // 2. å¾ç•¶å‰æ®µè½ä¸­ç§»é™¤é€™å€‹æ¨™é»ç¬¦è™Ÿ
            paragraphs[i] = paragraphs[i].substring(1);
        }
    }

    // éæ¿¾æ‰å¯èƒ½å› ä¿®æ­£è€Œè®Šç‚ºç©ºå­—ä¸²çš„æ®µè½
    return paragraphs.filter(p => p.trim() !== '');
}

            async function translateToEnglish(textToTranslate) {
    // ã€é‡è¦ã€‘è«‹å°‡æ­¤è™•çš„ä¿¡ç®±æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„æœ‰æ•ˆé›»å­éƒµä»¶åœ°å€
    const myEmail = 'kenchan20151@gmail.com'; 

    const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=zh-TW|en&de=${myEmail}`;

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`Translation API failed with status ${response.status}`);
        }
        const data = await response.json();

        if (data.responseStatus !== 200) {
            // MyMemory åœ¨é¡åº¦ç”¨ç›¡æ™‚çš„å›æ‡‰ç´°ç¯€
            if (data.responseDetails && data.responseDetails.includes("daily limit")) {
                 console.error('MyMemory API daily limit exceeded for this IP or email.');
                 throw new Error(`MyMemory API error: Daily limit exceeded.`);
            }
            throw new Error(`MyMemory API error: ${data.responseDetails}`);
        }

        if (data.responseData && data.responseData.translatedText) {
            return data.responseData.translatedText;
        } else {
            throw new Error('Translated text not found in API response.');
        }
    } catch (error) {
        console.error('Translation error:', error);
        return null; // ä¿æŒéŒ¯èª¤æ™‚è¿”å› null çš„è¡Œç‚º
    }
}
            
            function generateImagePrompt(englishParagraph) {
                return `Illustration of: "${englishParagraph}". Rendered in a classic manga style with an emphasis on simplicity. Use only black and white, with clean, uniform, and minimalist line art. The overall feel should be a high-contrast, clear monochrome comic panel or sketch. No text is included`;
            }
            
            async function generateSlidesSequentially(paragraphs) {
                slidesContainer.innerHTML = '';
                const baseSeed = Math.floor(Math.random() * 1000000);
                
                for (let i = 0; i < paragraphs.length; i++) {
                    const para = paragraphs[i];
                    
                    const progress = Math.floor((i / paragraphs.length) * 100);
                    progressBar.style.width = `${progress}%`;
                    
                    const tempSlide = document.createElement('div');
                    tempSlide.className = 'slide';
                    tempSlide.dataset.paragraph = para; // å„²å­˜åŸæ–‡ä»¥ä¾›é‡è©¦
                    tempSlide.innerHTML = `
                        <div class="slide-header">
                            <span>å¹»ç‡ˆç‰‡ ${i+1}/${paragraphs.length}</span>
                            <span>${para.length} å­—</span>
                        </div>
                        <div class="slide-image">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>æ­£åœ¨ç¿»è­¯æ–‡å­—...</p>
                            </div>
                        </div>
                        <div class="slide-text">
                            <p>${para}</p>
                        </div>
                    `;
                    slidesContainer.appendChild(tempSlide);
                    
                    slidesContainer.scrollTo({
                        left: tempSlide.offsetLeft - slidesContainer.offsetLeft,
                        behavior: 'smooth'
                    });
                    
                    const slideImageContainer = tempSlide.querySelector('.slide-image');
                    const loadingText = slideImageContainer.querySelector('.loading p');

                    const englishPara = await translateToEnglish(para);
                    
                    if (!englishPara) {
                        slideImageContainer.innerHTML = `
                         <div class="generation-error" data-action="retry-generation" title="é»æ“Šä»¥é‡æ–°ç”Ÿæˆæ­¤åœ–ç‰‡">
                             <i class="fas fa-language"></i>
                             <p>ç¿»è­¯å¤±æ•—ï¼Œç„¡æ³•ç”Ÿæˆåœ–ç‰‡ã€‚<br>è«‹é»æ“Šæ­¤è™•é‡è©¦ã€‚</p>
                         </div>`;
                        await new Promise(resolve => setTimeout(resolve, 500));
                        continue;
                    }
                    
                    loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆæ’åœ–...';
                    const prompt = generateImagePrompt(englishPara);
                    const imageUrl = `https://gen.pollinations.ai/prompt/${encodeURIComponent(prompt)}?token=pk_YIFWnDFts0quviE0&model=flux&enhance=false&private=true&nologo=true&seed=${baseSeed + i}`;
                    
                    const img = new Image();
                    await new Promise((resolve) => {
                        img.onload = () => {
                            img.style.cursor = 'pointer';
                            img.title = 'é»æ“Šä»¥é‡æ–°ç”Ÿæˆæ­¤åœ–ç‰‡';
                            slideImageContainer.innerHTML = '';
                            slideImageContainer.appendChild(img);
                            resolve();
                        };
                        img.onerror = () => {
                            // ã€ä¿®è¨‚ã€‘åœ–ç‰‡ç”Ÿæˆå¤±æ•—æ™‚ï¼Œé¡¯ç¤ºå¯é»æ“Šçš„é‡è©¦å€å¡Š
                            slideImageContainer.innerHTML = `
                                <div class="generation-error" data-action="retry-generation" title="é»æ“Šä»¥é‡æ–°ç”Ÿæˆæ­¤åœ–ç‰‡">
                                    <i class="fas fa-image-slash"></i>
                                    <p>åœ–ç‰‡ç”Ÿæˆå¤±æ•—ã€‚<br>è«‹é»æ“Šæ­¤è™•é‡è©¦ã€‚</p>
                                </div>`;
                            resolve(); // å³ä½¿å¤±æ•—ä¹Ÿè¦ç¹¼çºŒ
                        };
                        img.src = imageUrl;
                        img.alt = `ç¬¬${i+1}å¼µå¹»ç‡ˆç‰‡æ’åœ–`;
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                progressBar.style.width = '100%';
                
                prevSlideBtn.disabled = paragraphs.length === 0;
                nextSlideBtn.disabled = paragraphs.length === 0;
                
                slidesContainer.scrollTo({ left: 0, behavior: 'smooth' });
            }
            
            // ã€ä¿®è¨‚ã€‘å°‡é‡æ–°ç”Ÿæˆé‚è¼¯å°è£æˆä¸€å€‹ç¨ç«‹å‡½æ•¸
            async function regenerateImageForSlide(slideElement) {
                const imageContainer = slideElement.querySelector('.slide-image');
                const originalParagraph = slideElement.dataset.paragraph;

                if (!originalParagraph) {
                    showNotification('æ‰¾ä¸åˆ°åŸå§‹æ–‡æœ¬ï¼Œç„¡æ³•é‡æ–°ç”Ÿæˆã€‚', true);
                    return;
                }

                imageContainer.innerHTML = `
                    <div class="loading" style="padding: 20px;">
                        <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
                        <p style="font-size: 14px; margin-top: 10px;">ç¿»è­¯ä¸¦ç”Ÿæˆæ–°åœ–ç‰‡ä¸­...</p>
                    </div>`;

                try {
                    const englishPara = await translateToEnglish(originalParagraph);
                    if (!englishPara) {
                        throw new Error('ç¿»è­¯å¤±æ•—');
                    }

                    const prompt = generateImagePrompt(englishPara);
                    const newSeed = Math.floor(Math.random() * 10000000);
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?token=Jeq-UCxbpvrqUEzN&model=flux&enhance=false&private=true&nologo=true&seed=${newSeed}`;

                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = () => {
                            img.style.cursor = 'pointer';
                            img.title = 'é»æ“Šä»¥é‡æ–°ç”Ÿæˆæ­¤åœ–ç‰‡';
                            imageContainer.innerHTML = '';
                            imageContainer.appendChild(img);
                            resolve();
                        };
                        img.onerror = () => reject(new Error('åœ–ç‰‡ç”Ÿæˆå¤±æ•—'));
                        img.src = imageUrl;
                        img.alt = slideElement.querySelector('.slide-header span')?.textContent || 'é‡æ–°ç”Ÿæˆçš„æ’åœ–';
                    });
                    showNotification('åœ–ç‰‡å·²æˆåŠŸé‡æ–°ç”Ÿæˆï¼');
                } catch (error) {
                    const errorMessage = error.message || 'æœªçŸ¥éŒ¯èª¤';
                    // ã€ä¿®è¨‚ã€‘é‡æ–°ç”Ÿæˆå¤±æ•—æ™‚ï¼Œä¹Ÿè¦é¡¯ç¤ºå¯é»æ“Šçš„é‡è©¦å€å¡Š
                    imageContainer.innerHTML = `
                        <div class="generation-error" data-action="retry-generation" title="é»æ“Šä»¥é‡æ–°ç”Ÿæˆæ­¤åœ–ç‰‡">
                            <i class="fas fa-sync-alt"></i>
                            <p>é‡æ–°ç”Ÿæˆå¤±æ•—: ${errorMessage}ã€‚<br>è«‹é»æ“Šæ­¤è™•é‡è©¦ã€‚</p>
                        </div>`;
                    showNotification(`é‡æ–°ç”Ÿæˆå¤±æ•—ï¼š${errorMessage}`, true);
                }
            }

            // ã€ä¿®è¨‚ã€‘çµ±ä¸€çš„é»æ“Šäº‹ä»¶ç›£è½å™¨ï¼Œè™•ç†åœ–ç‰‡å’Œå¤±æ•—å¾Œçš„é‡è©¦
            slidesContainer.addEventListener('click', async function(event) {
                const retryTarget = event.target.closest('[data-action="retry-generation"]');
                const imageTarget = event.target.tagName === 'IMG' ? event.target : null;

                if (retryTarget || imageTarget) {
                    const isConfirmed = confirm('æ‚¨ç¢ºå®šè¦é‡æ–°ç”Ÿæˆé€™å¼µæ’åœ–å—ï¼Ÿ');
                    
                    if (isConfirmed) {
                        const slideElement = event.target.closest('.slide');
                        if (slideElement) {
                            await regenerateImageForSlide(slideElement);
                        }
                    }
                }
            });
            
            // å¹»ç‡ˆç‰‡å°èˆª
            prevSlideBtn.addEventListener('click', function() {
                const slideWidth = slidesContainer.querySelector('.slide')?.offsetWidth || 0;
                const scrollAmount = slidesContainer.scrollLeft - (slideWidth + 30);
                slidesContainer.scrollTo({
                    left: scrollAmount < 0 ? 0 : scrollAmount,
                    behavior: 'smooth'
                });
            });
            
            nextSlideBtn.addEventListener('click', function() {
                const slideWidth = slidesContainer.querySelector('.slide')?.offsetWidth || 0;
                const scrollAmount = slidesContainer.scrollLeft + (slideWidth + 30);
                slidesContainer.scrollTo({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
            });
            
            // åˆå§‹ç¦ç”¨å°èˆªæŒ‰éˆ•
            prevSlideBtn.disabled = true;
            nextSlideBtn.disabled = true;
        });
    </script>

<!-- === å¤§ç¶±ç·¨è¼¯æ‡¸æµ®è¦–çª— (ä¿®æ­£ç‰ˆ) === -->
<div id="outline-editor-modal" class="outline-modal-overlay">
    <div class="outline-modal-content">
        <h3 id="modal-title">ç·¨è¼¯å…§å®¹</h3>
        <textarea id="modal-textarea" rows="15"></textarea>
        <div class="modal-buttons">
            <!-- ã€æ–°å¢çš„æŒ‰éˆ•ã€‘ -->
            <button id="modal-ocr-btn" class="btn-action" style="background-color: #17a2b8;">OCR</button>
            
            <button id="modal-save-btn" class="btn-action">è¼¸å…¥</button>
        </div>
        <button id="modal-close-btn" class="preview-close-btn" title="é—œé–‰">&times;</button>
    </div>
</div>

<!-- === [æ–°å¢] ç¥æ€å¤§æ•¸æ“šæ”¶é›†æ¨¡çµ„ (é›™è»Œåˆ¶å¯«å…¥ç‰ˆ - ç­ç´šå„ªåŒ–) === -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let totalSeconds = 0;
    let timerInterval = null;
    // 1. ç²å–è©³ç´°æ—¥æœŸè·¯å¾‘ (çµ¦ analytics ç”¨) -> 2025/01/16
    function getDatePath() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}/${m}/${d}`;
    }
    // 2. ç²å–æœˆåº¦ç¸½çµè·¯å¾‘ (çµ¦ summary ç”¨) -> 2025/01
    function getSummaryPath() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        return `${y}/${m}`;
    }
    // 3. ç²å–æˆ–ç”Ÿæˆè¨ªå®¢å”¯ä¸€ ID
    function getGuestID() {
        let id = localStorage.getItem('sansi_guest_uuid');
        if (!id) {
            id = 'guest_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            localStorage.setItem('sansi_guest_uuid', id);
        }
        return id;
    }
    // 4. è¨˜éŒ„è¨ªå• (Log Visit)
    function logVisitOnce() {
        if (typeof firebase === 'undefined') return;
        const db = firebase.database();
        const pathSuffix = getDatePath();       // è©³ç´°è·¯å¾‘
        const summarySuffix = getSummaryPath(); // è¼•é‡è·¯å¾‘ (YYYY/MM)
        
        const rawProfile = localStorage.getItem('studentProfile');
        let s = null;
        try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}
        let currentIdentityID = '';
        let isStudent = false;
        if (s && s.grade && s.class && s.name) {
            currentIdentityID = `student_${s.grade}${s.class}_${s.name}`;
            isStudent = true;
        } else {
            currentIdentityID = `guest_${getGuestID()}`;
            isStudent = false;
        }
        const lastLoggedID = sessionStorage.getItem('sansi_logged_identity_id');
        if (currentIdentityID === lastLoggedID) {
            return;
        }
        console.log(`ğŸ“ [System] åµæ¸¬åˆ°æ–°èº«ä»½è¨ªå• (${isStudent ? 'å­¸ç”Ÿ' : 'è¨ªå®¢'}), æ­£åœ¨è¨˜éŒ„...`);
        // é€šç”¨åŠ æ³•å™¨
        const incrementData = (path) => {
            db.ref(path).transaction(data => {
                if (data === null) return { visits: 1, duration: 0 };
                return { visits: (data.visits || 0) + 1, duration: (data.duration || 0) };
            });
        };
        // A. å¯«å…¥è©³ç´°æ—¥èªŒ (Analytics)
        if (isStudent) {
            incrementData(`analytics/${pathSuffix}/students/${s.grade}/${s.class}/${s.name}`);
            incrementData(`analytics/${pathSuffix}/classes/${s.grade}${s.class}`);
            incrementData(`analytics/${pathSuffix}/school`);
 
            // â˜…â˜…â˜… [æ–°å¢] åŒæ­¥å¯«å…¥ç­ç´šè¼•é‡çµ±è¨ˆ (æµé‡æ•‘æ˜Ÿ) â˜…â˜…â˜…
            // è·¯å¾‘ä¾‹å¦‚: class_stats_summary/6/A/2025/01
            incrementData(`class_stats_summary/${s.grade}/${s.class}/${summarySuffix}`);
        } else {
            incrementData(`analytics/${pathSuffix}/guests/${getGuestID()}`);
        }
        // B. å¯«å…¥å…¨åŸŸè¼•é‡çµ±è¨ˆ
        if (!sessionStorage.getItem('sansi_global_visit_logged')) {
            incrementData(`analytics/${pathSuffix}/global_summary`); // èˆŠç‰ˆå‚™ä»½
            incrementData(`stats_summary/${summarySuffix}`);       // æ–°ç‰ˆå…¨åŸŸè¼•é‡
            sessionStorage.setItem('sansi_global_visit_logged', 'true');
        }
        sessionStorage.setItem('sansi_logged_identity_id', currentIdentityID);
    }
    // 5. ä¸Šå‚³æ™‚é–“ (æ¯åˆ†é˜)
    function uploadOneMinute() {
        if (typeof firebase === 'undefined') return;
        
        // ç¢ºä¿è‡³å°‘æœ‰ä¸€æ¬¡è¨ªå•è¨˜éŒ„
        logVisitOnce();
        const db = firebase.database();
        const pathSuffix = getDatePath();       
        const summarySuffix = getSummaryPath();
        
        const rawProfile = localStorage.getItem('studentProfile');
        let s = null;
        try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}
        const add60s = (path) => {
            db.ref(path).transaction(data => {
                if (data === null) return { visits: 0, duration: 60 };
                return { visits: (data.visits || 0), duration: (data.duration || 0) + 60 };
            });
        };
        // A. æ›´æ–°è©³ç´°æ—¥èªŒæ™‚é•·
        add60s(`analytics/${pathSuffix}/global_summary`);
        if (s && s.grade && s.class && s.name) {
            add60s(`analytics/${pathSuffix}/school`);
            add60s(`analytics/${pathSuffix}/classes/${s.grade}${s.class}`);
            add60s(`analytics/${pathSuffix}/students/${s.grade}/${s.class}/${s.name}`);
 
            // â˜…â˜…â˜… [æ–°å¢] åŒæ­¥æ›´æ–°ç­ç´šè¼•é‡çµ±è¨ˆæ™‚é•· â˜…â˜…â˜…
            add60s(`class_stats_summary/${s.grade}/${s.class}/${summarySuffix}`);
        } else {
            const guestID = getGuestID();
            add60s(`analytics/${pathSuffix}/guests/${guestID}`);
        }
        // B. æ›´æ–°å…¨åŸŸè¼•é‡çµ±è¨ˆ
        add60s(`stats_summary/${summarySuffix}`);
    }
    // 6. è¨ˆæ™‚å™¨æ§åˆ¶
    function startTimer() {
        if (timerInterval) return;
        console.log("â–¶ï¸ [System] è¨ˆæ™‚å™¨å·²å•Ÿå‹•");
        timerInterval = setInterval(() => {
            totalSeconds++;
            if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                uploadOneMinute();
            }
        }, 1000);
    }
    function pauseTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            console.log("â¸ï¸ [System] è¨ˆæ™‚å·²æš«åœ");
        }
    }
    setTimeout(logVisitOnce, 3000);
    startTimer();
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') pauseTimer();
        else startTimer();
    });
    
    window.forceLogVisit = logVisitOnce;
});
</script>
    
    
</body>
</html>
